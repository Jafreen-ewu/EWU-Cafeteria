<?php require '../config.php'; require '../includes/header.php'; if(!isset($_SESSION['role'])||$_SESSION['role']!=='student'){ header('Location: ../login.php'); exit;} if($_SERVER['REQUEST_METHOD']==='POST'){ $uid=$_SESSION['user_id']; $mid=intval($_POST['menu_id']); $qty=intval($_POST['qty']); $method=$_POST['method']; $it=$conn->query('SELECT * FROM menu WHERE id='.(int)$mid)->fetch_assoc(); if(!$it){ die('Item not found'); } if($it['stock']<$qty){ echo '<div class="card p-3"><div class="alert alert-danger">Not enough stock</div><a class="btn btn-link" href="menu.php">Back</a></div>'; exit; } $total=$it['price']*$qty; if($method==='WALLET'){ $bal=$conn->query('SELECT wallet FROM users WHERE id='.(int)$uid)->fetch_assoc()['wallet']; if($bal<$total){ echo '<div class="card p-3"><div class="alert alert-danger">Insufficient wallet balance</div><a class="btn btn-link" href="wallet.php">Top-up</a></div>'; exit; } $st=$conn->prepare('UPDATE users SET wallet=wallet-? WHERE id=?'); $st->bind_param('di',$total,$uid); $st->execute(); $st->close(); } $st=$conn->prepare('INSERT INTO orders (user_id,menu_id,qty,total,payment_method) VALUES (?,?,?,?,?)'); $st->bind_param('iiids',$uid,$mid,$qty,$total,$method); $st->execute(); $st->close(); $st=$conn->prepare('UPDATE menu SET stock=stock-? WHERE id=?'); $st->bind_param('ii',$qty,$mid); $st->execute(); $st->close(); echo '<div class="card p-3"><div class="alert alert-success">Order placed à§³'.number_format($total,2).'</div><a class="btn btn-link" href="menu.php">Back</a></div>'; exit; } header('Location: menu.php'); exit; ?>